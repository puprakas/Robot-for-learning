<!DOCTYPE html>
<html lang="en">
	<head>
		<title>New Media Lab</title>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" crossorigin="anonymous"/>
		<link rel="stylesheet" href="../styles/style.css" >
		<link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@500&display=swap" rel="stylesheet">
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	</head>
	<body  onload = "followMouse();">
		<div class="curtain">
			<div id="ball"></div>
			<div class="container-fluid main">
				<div class="row">
					<div class="col-8">
						<div class="highlight"></div>
						<div class="board-bg">
							<div class="board">
							</div>
						</div>
						<div id='ball-area'>
							<div class="container available-options">
								<div class="row mt-4">
									<div class=" col-md-2 col-xs-4 mt-3">
										<div class="option red-option"></div>
									</div>
									<div class=" col-md-2 col-xs-4 mt-3">
										<div class="option orange-option"></div>
									</div>
									<div class=" col-md-2 col-xs-4 mt-3">
										<div class="option yellow-option"></div>
									</div>
									<div class=" col-md-2 col-xs-4 mt-3">
										<div class="option green-option"></div>
									</div>
									<div class=" col-md-2 col-xs-4 mt-3">
										<div class="option blue-option"></div>
									</div>
									<div class=" col-md-2 col-xs-4 mt-3">
										<div class="option purple-option"></div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="col-4">
						<div class="robo-screen">
							<div class="robo-container">
								<div class="robo">
									<div class="robo-eyes">
										<div class="left-eyeball eyeball"></div>
										<div class="right-eyeball eyeball"></div>
									</div>
								</div>
							</div>
							<div class="text-box"><p id='text-area'>placeholder<p></div>
						</div>
						<div id='button-area'>
							<div class="button-area">
								<div id="positive" class="dialogue-btn btn-left">
									<span class="away">Yes</span>
									<span class="over">That is correct!</span>
								</div>
								<div id="negative" class="dialogue-btn btn-right">
									<span class="away">No</span>
									<span class="over">You are wrong!</span>
								</div>
							</div>
						</div>
						<div id='next-area'>
							<div class="next-area">
								<div id="dialogue-next" class='btn btn-success'>Next &raquo;</div>
							</div>
						</div>
						<div id='slider-area'>
							<div class="slider-area">
								<input class="range-slider" type="range" min="1" max="100" step="0.1" value="50">
							</div>
						</div>
						<div id='numberinput-area'>
							<div class="numberinput-area">
								<div class="value-button" id="decrease" onclick="decreaseValue()" value="Decrease Value">-</div>
								<input type="number" id="number" disabled value="1" />
								<div class="value-button" id="increase" onclick="increaseValue()" value="Increase Value">+</div>
							</div>
							<div class="numberinput-btn">OK<div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
	<footer>
		<script type="text/javascript">
			$('.curtain').fadeIn(3000)
			var size = 8;
			var board = $('.board');
			var board_state = [
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0]
			]
			for (var i = 0; i < size * size; i++) {
				board.append('<div id= "square_'+ i +'" class="square"></div>');
				// TODO
				// let x = parseInt(i/size);
				// let y = i%size;
			}
			var slider = $('.range-slider');
			var highlighter = $('.highlight');
			var square_h = parseInt($('.square').css("height").replace(/[^-\d\.]/g, '')) + 0.8;
			var extra_padding = parseInt($('.board-bg').css("padding-top").replace(/[^-\d\.]/g, ''));
			highlighter.css("margin-top", (extra_padding + (square_h * (size / 2))) + 'px');
			slider.bind('input', function(){
				let scale = Math.round(this.value * (size - 1 ) / 100);
				highlighter.css("margin-top", extra_padding + square_h * scale + 'px');
			});
			/*
			var state = 0
			$('#super_button').click(function() {
				if (state==0) {
					$('.button-area').css("display","none")
					$('.slider-area').css("display","inline-block")
					highlighter.css("display","block")
					state=1
				}
				else {
					$('.slider-area').css("display","none")
					highlighter.css("display","none")
					$('.button-area').css("display","flex")
					state=0
				}
			});
			*/
			function increaseValue() {
				var value = parseInt(document.getElementById('number').value, 10);
				value = isNaN(value) ? 0 : value;
				value > 7 ? value = 7 : '';
				value++;
				document.getElementById('number').value = value;
			}
			function decreaseValue() {
				var value = parseInt(document.getElementById('number').value, 10);
				value = isNaN(value) ? 0 : value;
				value < 2 ? value = 2 : '';
				value--;
				document.getElementById('number').value = value;
			}
			var on = document.addEventListener.bind(document);
			var xmouse, ymouse;
			on('mousemove', function (e) {
				xmouse = e.clientX || e.pageX;
				ymouse = e.clientY || e.pageY;
			});
			var ball = $('#ball');
			var x = 0,
			y = 0,
			dx = 0,
			dy = 0,
			key = -1;
			var followMouse = function followMouse() {
				key = requestAnimationFrame(followMouse);
				if(!x || !y) {
					x = xmouse;
					y = ymouse;
				} else {
					dx = (xmouse - x) * 0.125;
					dy = (ymouse - y) * 0.125;
					if(Math.abs(dx) + Math.abs(dy) < 0.1) {
						x = xmouse;
						y = ymouse;
					} else {
						x += dx;
						y += dy;
					}
				}
				x = x + 50 > $( document ).width() ? $( document ).width() - 50  : x;
				y = y + 50 > $( document ).height() ? $( document ).height() - 50 : y;
				ball.css("left", x + 'px');
				ball.css("top", y + 'px');
			};
			var picked = false;
			$('.option').click(function() {
				ball.removeClass();
				ball.css('display', 'block');
				ball.addClass(this.className.split(/\s+/)[1]);
				picked = true;
			})
			// HELPERS
			var colour_dict = {
				0:'white',
				1:'red',
				2:'orange',
				3:'yellow',
				4:'green',
				5:'blue',
				6:'purple'
			}
			var target_img = [
				[2,2,2,2,2,2,2,2],
				[2,1,1,1,1,1,1,2],
				[2,1,1,1,1,1,1,2],
				[2,0,0,0,0,0,0,2],
				[2,0,0,0,0,0,0,2],
				[2,5,5,5,5,5,5,2],
				[2,5,5,5,5,5,5,2],
				[2,2,2,2,2,2,2,2]
			]
			function boardComplete(target_img) {
				//return board_state.toString() == target_img.toString()
				
				for (j=0;j<size;j++) {
					for (i=0;i<size;i++) {
						if (target_img[i][j] != board_state[i][j])
							return false
						}
				}
				return true
			}
			function rowOccupied(x) {
				var sum = 0;
				for (var i = 0; i < board_state.length; i++) {
					for (var j = 0; j < board_state[i].length; j++) {
						sum += board_state[i][j];
					}
				}
				return sum;
			}
			function numberToPrint(number) {
				switch(number){
					case 0:
						return ((number + 1) + 'st')
					case 1:
						return ((number + 1) + 'nd')
					case 2:
						return ((number + 1) + 'rd')
				}
				return ((number + 1) + 'th')
			}
			function getKeyByValue(object, value) {
				return Object.keys(object).find(key => object[key] === value);
			}
			function squareOccupied(x, y) {
				return board_state[x][y] != 0
			}
			function getRandomNumber(min, max) {
				return parseInt(Math.random() * (max - min) + min);
			}
			function getButtons() {
				return $('#button-area')
			}
			function getSlider() {
				return $('#slider-area')
			}
			function getNumberInput() {
				return $('#numberinput-area')
			}
			function getBalls() {
				return $('#ball-area')
			}
			function highlightRow(x) {
				var highlighter = $('.highlight');
				var square_h = parseInt($('.square').css("height").replace(/[^-\d\.]/g, '')) + 0.8;
				var extra_padding = parseInt($('.board-bg').css("padding-top").replace(/[^-\d\.]/g, ''));
				highlighter.css("margin-top", extra_padding + square_h * x + 'px');
				highlighter.css("display", 'block');
			}
			function roboQuest(text, type = -1) {
				switch(type){
					case -1:
						$('#button-area').fadeOut(2000)
						$('#numberinput-area').fadeOut(2000)
						$('#ball-area').fadeOut(2000)
						break;
					case 0:
						$('#button-area').fadeIn(2000)
						break
					case 1:
						$('#numberinput-area').fadeIn(2000)
						break
					case 2:
						$('#ball-area').fadeIn(2000)
						break
				}
				$('#text-area').text(text) // to placeholder
			}

			
			var init = true

			var controller = [true, true]
			function setController(i) {
				controller[i] = false
			}
			function getController(i) {
				return controller[i]
			}

			begin(init)
			function begin(init = false) {
				$('#text-area').text('Intro text')
				$('#next-area').fadeIn(2000)
				$('#dialogue-next').click(function() {
					if (getController(0)) {
						setController(0)
						func_1()
					}
					
				});
				function func_1() {
						alert('func_1')
						$('#next-area').fadeOut(2000)
						var current_row = getRandomNumber(0, 8)
						while(rowOccupied(current_row)) { // FIX
							current_row = getRandomNumber(0, 8)
						}
						var p = getRandomNumber(-1, 3)
						p = p == 2 ? 0 : p
						//p=1
						p = current_row + p > 7 || current_row + p < 1 ? 0 : p
						highlightRow(current_row)
						$('#text-area').text('I think this is the '+ numberToPrint(current_row + p) + ' row. Do you think so too?')
						$('#button-area').fadeIn(2000)

						if(p!=0) {
							alert('p!=0')
							$('#positive').click( function() {
								$('#button-area').fadeOut(2000)
								$('#text-area').text('oh shit i was wrong (so you are wrong!)')
								// trial row
								$('#next-area').fadeIn(2000)
								$('#dialogue-next').click(function() {
									$('#text-area').text('Which row would this one be?')
									$('#next-area').fadeOut(2000)
									$('#numberinput-area').fadeIn(2000)
								});
							})
							$('#negative').click( function() {
								$('#button-area').fadeOut(2000)
								$('#text-area').text('oh shit nigga you are right that is not the ' + numberToPrint(current_row + p) +' row.')
								// trial row
								$('#next-area').fadeIn(2000)
								$('#dialogue-next').click(function() {
									$('#text-area').text('Which row do you think that is?')
									$('#next-area').fadeOut(2000)
									$('#numberinput-area').fadeIn(2000)
								});
							})
							$('.numberinput-btn').click(function() {
								while ( ($('#number').val()-1) != current_row) {
									$('#text-area').text('Oh, I think this is wrong! Let us try again.')
									$('#numberinput-area').fadeOut(2000)
									$('#next-area').fadeIn(2000)
									$('#dialogue-next').click(function() {
										alert('test4')
										$('#numberinput-area').fadeIn(2000)
									});
								}

								if(($('#number').val()-1)==current_row) {
									$('#text-area').text('Correct! You found the highlighted row!')
									$('#numberinput-area').fadeOut(2000)
									$('#next-area').fadeIn(2000)
									$('#dialogue-next').click(function() {
										$('#next-area').fadeOut(2000)
										alert('test3')
										insideRow(current_row)
									});
								}
							})
						}
						else {
							alert('p==0')
							$('#positive').click( function() {
								$('#button-area').fadeOut(2000)
								$('#text-area').text('Yes we agree! That is indeed the ' + numberToPrint(current_row) + ' row.')
								$('#next-area').fadeIn(2000)
								$('#dialogue-next').click(function() {
									$('#next-area').fadeOut(2000)
									setController(0)
									alert('test1')
									insideRow(current_row)
								});
							})
							$('#negative').click( function() {
								$('#button-area').fadeOut(2000)
								$('#text-area').text('Oh wait. I think I was right. That is indeed the ' + numberToPrint(current_row) + ' row.')
								$('#next-area').fadeIn(2000)
								$('#dialogue-next').click(function() {
									$('#next-area').fadeOut(2000)
									alert('test2')
									insideRow(current_row)
								});
							})
						}
						alert('end of func_1')
				}
				function insideRow(current_row){
					alert('insideRow')
					var current_col = getRandomNumber(0, 8)
					var colour_key = getRandomNumber(1, 7)
					$('.highlight').css ('display','none')
					$('#text-area').text('Place the ' + colour_dict[colour_key] + ' ball in the ' + numberToPrint(current_col) + ' position of the ' + numberToPrint(current_row)  + ' row')
					$('#ball-area').fadeIn(2000)
					$('.square').click(function() {
						var curr_square = this
						if(picked) {
							if ($('#'+curr_square.id).attr('class').split(' ').length > 1) {
								$('#'+curr_square.id).removeClass($('#'+this.id).attr('class').split(' ').pop());
							}
							$('#'+curr_square.id).addClass(ball.attr('class'));
							var pickedKeyColour = getKeyByValue(colour_dict, ball.attr('class').split('-')[0])
							ball.css('display', 'none');
							ball.removeClass();
							if(colour_key == pickedKeyColour) {
								alert('correct colour')
								if(current_row != parseInt(this.id.split('_')[1]/8)) {
									$('#text-area').text('Kid misclicked')
								}
								else {
									if(current_col == this.id.split('_')[1]%8) {
										alert('correct col')
										$('#text-area').text('Objective completed')
										board_state[current_row][current_col] =  target_img[current_row][current_col]
										alert('calling func')
										$('#next-area').fadeIn(2000)
										$('#dialogue-next').click(function() {
											func_1()
										}); 
									}
									else {
										alert('2')
										$('#text-area').text('That is not the right square!')
										$('#next-area').fadeIn(2000)
										$('#dialogue-next').click(function() {
											$('#text-area').text('I asked you to place the ball into the ' + numberToPrint(current_col) + ' square but instead you picked the '
												+ numberToPrint(curr_square.id.split('_')[1]%8) + ' one. Lets try again!')
										});
									}
								}
							}
							else {
								$('#text-area').text('You have picked the wrong colour I believe!')
								$('#next-area').fadeIn(2000)
								$('#dialogue-next').click(function() {
									$('#'+curr_square.id).removeClass($('#'+curr_square.id).attr('class').split(' ')[1]);
									$('#text-area').text('I asked you to pick the ' + colour_dict[colour_key] + ' ball but instead you picked the '
										+ colour_dict[pickedKeyColour] + ' one. Lets try again!')
									// trial colour
									$('#next-area').fadeIn(2000)
									$('#dialogue-next').click(function() {
										//colourTrial(colour_key)
									});
								});
							}
						}
						else {
							//LOCK?
							alert('222')
							if ($('#'+curr_square.id).attr('class').split(' ').length > 1) {
								$('#'+curr_square.id).removeClass($('#'+curr_square.id).attr('class').split(' ').pop());
							}
						}
					});
					/*
					if ball placed::
					square correct?
					colour correct?
					if color picked == color requested
					*/

				}
				function colourTrial(req_colour){
					$('#text-area').text('Pick the ' + colour_dict[req_colour] + ' ball.')
					$('.option').click(function() {
						var picked_ball = getKeyByValue(colour_dict, this.className.split(/\s+/)[1].split('-')[0])
						if(picked_ball == req_colour) {
							alert('yay')
							$('#text-area').text('That is indeed the ' + colour_dict[req_colour] + ' ball.')
							return
						}
						else if(picked_ball != req_colour) {
							$('#ball').css('display', 'none');
							$('#ball').removeClass();
							$('#text-area').text('That is not the requested ball. Pick the ' + colour_dict[req_colour] + ' ball.')
							$('#next-area').fadeIn(2000)
							$('#dialogue-next').click(function() {
								$('#next-area').fadeOut(2000)
								colourTrial(req_colour)
							});
						}
					})
				}
			}
			
		</script>
	</footer>
</html>
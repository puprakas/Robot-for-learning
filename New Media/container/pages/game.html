<!DOCTYPE html>
<html lang="en">
	<head>
		<title>New Media Lab</title>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" crossorigin="anonymous"/>
		<link rel="stylesheet" href="../styles/style.css" >
		<link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@500&display=swap" rel="stylesheet">
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	</head>
	<body  onload = "followMouse();">
		<div class="curtain">
			<div id="ball"></div>
			<div class="container-fluid main">
				<div class="row">
					<div class="col-8">
						<div class="highlight"></div>
						<div class="row_indicator"></div>
						<div class="board-bg">
							<div class="board">
							</div>
						</div>
						<div id='ball-area'>
							<div class="container available-options">
								<div class="row mt-4">
									<div class=" col-md-2 col-xs-4 mt-3">
										<div class="option red-option"></div>
									</div>
									<div class=" col-md-2 col-xs-4 mt-3">
										<div class="option orange-option"></div>
									</div>
									<div class=" col-md-2 col-xs-4 mt-3">
										<div class="option yellow-option"></div>
									</div>
									<div class=" col-md-2 col-xs-4 mt-3">
										<div class="option green-option"></div>
									</div>
									<div class=" col-md-2 col-xs-4 mt-3">
										<div class="option blue-option"></div>
									</div>
									<div class=" col-md-2 col-xs-4 mt-3">
										<div class="option purple-option"></div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="col-4">
						<div class="robo-screen">
							<div class="robo-container">
								<div class="robo">
									<div class="robo-eyes">
										<div class="left-eyeball eyeball"></div>
										<div class="right-eyeball eyeball"></div>
									</div>
								</div>
							</div>
							<div class="text-box"><p id='text-area'>placeholder<p></div>
						</div>
						<div id='button-area'>
							<div class="button-area">
								<div id="positive" class="dialogue-btn btn-left">
									<span class="away">Yes</span>
									<span class="over">That is correct!</span>
								</div>
								<div id="negative" class="dialogue-btn btn-right">
									<span class="away">No</span>
									<span class="over">You are wrong!</span>
								</div>
							</div>
						</div>
						<div id='next-area'>
							<div class="next-area">
								<div id="dialogue-next" class='btn btn-success'>Next &raquo;</div>
							</div>
						</div>
						<div id='slider-area'>
							<div class="slider-area">
								<input class="range-slider" type="range" min="1" max="100" step="0.1" value="50">
							</div>
						</div>
						<div id='numberinput-area'>
							<div class="numberinput-area">
								<div class="value-button" id="decrease" onclick="decreaseValue()" value="Decrease Value">-</div>
								<input type="number" id="number" disabled value="1" />
								<div class="value-button" id="increase" onclick="increaseValue()" value="Increase Value">+</div>
							</div>
							<div class="numberinput-btn">OK<div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
	<footer>
		<script type="text/javascript">
			$('.curtain').fadeIn(3000)
			var size = 8;
			var board = $('.board');
			for (var i = 0; i < size * size; i++) {
				board.append('<div id= "square_'+ i +'" class="square"></div>');
			}
			var slider = $('.range-slider');
			var highlighter = $('.highlight');
			var square_h = parseInt($('.square').css("height").replace(/[^-\d\.]/g, '')) + 0.8;
			var extra_padding = parseInt($('.board-bg').css("padding-top").replace(/[^-\d\.]/g, ''));
			highlighter.css("margin-top", (extra_padding + (square_h * (size / 2))) + 'px');
			slider.bind('input', function(){
				let scale = Math.round(this.value * (size - 1 ) / 100);
				highlighter.css("margin-top", extra_padding + square_h * scale + 'px');
			});
			var row_indicator = $('.row_indicator');
			row_indicator.css("width", square_h)
			row_indicator.css("top", extra_padding)
			row_indicator.css('margin-left', board.css("margin-left"))
			for (var i = 0; i < size; i++) {
				row_indicator.append('<div id= "row_'+ i +'" class="indicator"><p>' + (i+1) + '</p></div>');
			}
			$('.indicator').css('height', square_h)
			function increaseValue() {
				var value = parseInt(document.getElementById('number').value, 10);
				value = isNaN(value) ? 0 : value;
				value > 7 ? value = 7 : '';
				value++;
				document.getElementById('number').value = value;
			}
			function decreaseValue() {
				var value = parseInt(document.getElementById('number').value, 10);
				value = isNaN(value) ? 0 : value;
				value < 2 ? value = 2 : '';
				value--;
				document.getElementById('number').value = value;
			}
			var on = document.addEventListener.bind(document);
			var xmouse, ymouse;
			on('mousemove', function (e) {
				xmouse = e.clientX || e.pageX;
				ymouse = e.clientY || e.pageY;
			});
			var ball = $('#ball');
			var x = 0,
			y = 0,
			dx = 0,
			dy = 0,
			key = -1;
			var followMouse = function followMouse() {
				key = requestAnimationFrame(followMouse);
				if(!x || !y) {
					x = xmouse;
					y = ymouse;
				} else {
					dx = (xmouse - x) * 0.125;
					dy = (ymouse - y) * 0.125;
					if(Math.abs(dx) + Math.abs(dy) < 0.1) {
						x = xmouse;
						y = ymouse;
					} else {
						x += dx;
						y += dy;
					}
				}
				x = x + 50 > $( document ).width() ? $( document ).width() - 50  : x;
				y = y + 50 > $( document ).height() ? $( document ).height() - 50 : y;
				ball.css("left", x + 'px');
				ball.css("top", y + 'px');
			};
			function getImage(i) {
				images = {
					0: {
						name: 'flag',
						desc: 'our flag',
						img: [
							[2,2,2,2,2,2,2,2],
							[2,1,1,1,1,1,1,2],
							[2,1,1,1,1,1,1,2],
							[2,0,0,0,0,0,0,2],
							[2,0,0,0,0,0,0,2],
							[2,5,5,5,5,5,5,2],
							[2,5,5,5,5,5,5,2],
							[2,2,2,2,2,2,2,2]
						]
					},
					1: {
						name: 'fruit',
						desc: 'fruits',
						img: [
							[0,0,0,0,4,4,0,0],
							[0,0,0,0,0,2,0,0],
							[0,0,0,0,0,2,2,0],
							[0,0,0,0,0,2,4,4],
							[2,0,0,0,2,1,1,0],
							[2,2,2,2,1,1,1,1],
							[0,2,2,2,1,1,1,1],
							[0,0,0,0,0,1,1,0]
						]
					},
					2: {
						name: 'flower',
						desc: 'flowers',
						img: [
							[0,0,0,0,0,5,6,5],
							[5,6,5,0,0,6,3,6],
							[6,3,6,0,0,5,6,5],
							[5,6,5,2,1,2,4,0],
							[0,4,0,1,3,1,4,0],
							[0,4,0,2,1,2,0,0],
							[0,0,0,0,4,0,0,0],
							[0,0,0,0,4,0,0,0]
						]
					},
					3: {
						name: 'lion',
						desc: 'a lion',
						img: [
							[0,1,1,1,1,1,1,0],
							[1,3,3,1,1,3,3,1],
							[1,3,3,3,3,3,3,1],
							[1,1,5,3,3,5,1,1],
							[1,1,3,3,3,3,1,1],
							[1,1,3,2,2,3,1,1],
							[0,1,1,3,3,1,1,0],
							[0,0,1,1,1,1,0,0]
						]
					},
					4: {
						name: 'rainbow',
						desc: 'a rainbow',
						img: [
							[0,0,0,1,1,0,0,0],
							[0,1,1,2,2,1,1,0],
							[1,2,2,3,3,2,2,1],
							[2,3,3,4,4,3,3,2],
							[3,4,4,5,5,4,4,3],
							[4,5,5,6,6,5,5,4],
							[5,6,6,0,0,6,6,5],
							[6,0,0,0,0,0,0,6]
						]
					}
				}
				return images[i]
			}
			let searchParams = new URLSearchParams(window.location.search)
			var img_id = searchParams.has('mode') ?  searchParams.get('mode') : 0
			var lvl = searchParams.has('level') ?  searchParams.get('level') : 0
			var picked = false;
			var locked = false
			var target_img = getImage(img_id).img
			var board_state = [
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0],
				[0,0,0,0,0,0,0,0]
			]
			function imageFilled() {
				return board_state.toString() == target_img.toString()
			}
			function rowOccupied(x) {
				for (var i = 0; i < size; i++) {
					if (board_state[x][i] != target_img[x][i])
						return false
				}
				return true
			}
			function getColours() {
				return {
					0:'white',
					1:'red',
					2:'orange',
					3:'yellow',
					4:'green',
					5:'blue',
					6:'purple'
				}
			}
			function numberToPrint(number) {
				switch(number){
					case 0:
						return ((number + 1) + 'st')
					case 1:
						return ((number + 1) + 'nd')
					case 2:
						return ((number + 1) + 'rd')
				}
				return ((number + 1) + 'th')
			}
			function getKeyByValue(object, value) {
				return Object.keys(object).find(key => object[key] === value);
			}
			function squareOccupiedOrWhite(x, y) {
				return board_state[x][y] != 0 || target_img[x][y] == 0
			}
			function getRandomNumber(min, max) {
				return parseInt(Math.random() * (max - min) + min);
			}
			function highlightRow(x) {
				var highlighter = $('.highlight');
				var square_h = parseInt($('.square').css("height").replace(/[^-\d\.]/g, '')) + 0.8;
				var extra_padding = parseInt($('.board-bg').css("padding-top").replace(/[^-\d\.]/g, ''));
				highlighter.css("margin-top", extra_padding + square_h * x + 'px');
				highlighter.fadeIn(900);
			}
			function getHandlers() {
				return [$('#dialogue-next'), $('#positive'), $('#negative'), $('.numberinput-btn'), $('.square'), $('.option')]
			}
			function popColour(obj) {
				if (obj.attr('class').split(' ').length > 1) {
					obj.removeClass(obj.attr('class').split(' ').pop());
				}
			}
			early_game()
			function early_game() {
				$('#text-area').text('Intro text')
				$('#next-area').fadeIn(900)
				$('#dialogue-next').click(function() {
					$('#next-area').fadeOut(400, function() {
						$('#dialogue-next').unbind()
							mid_game()
						})
				});
			}
			function mid_game() {
				$('#next-area').fadeOut(400, function () {
					var req_row = getRandomNumber(0, 8)
					while(rowOccupied(req_row)) { // FIX
						req_row = getRandomNumber(0, 8)
					}
					var p = getRandomNumber(-1, 3)
					p = p == 2 ? 0 : p
					p = req_row + p > 7 || req_row + p < 1 ? 0 : p
					highlightRow(req_row)
					$('#text-area').text('I think this is the '+ numberToPrint(req_row + p) + ' row. Do you think so too?')
					$('#button-area').fadeIn(900)
					if(p!=0) {
						$('#positive').click( function() {
							$('#button-area').fadeOut(400, function () {
								$('#text-area').text("Oh no, wait! I think I was wrong after all. Which row would this one be?")
								trialRow(req_row)
							})
						})
						$('#negative').click( function() {
							$('#button-area').fadeOut(400, function () {
								$('#text-area').text('Then which row do you think this is?')
								trialRow(req_row)
							})
						})
					}
					else {
						$('#positive').click( function() {
							$('#button-area').fadeOut(400, function () {
								$('#text-area').text('Yes we agree! That is indeed the ' + numberToPrint(req_row) + ' row.')
								$('#next-area').fadeIn(900)
								$('#dialogue-next').click(function() {
									$('#dialogue-next').unbind()
									$('#next-area').fadeOut(400, function () {
										insideRow(req_row)
									})
								});
							})
						})
						$('#negative').click( function() {
							$('#button-area').fadeOut(400, function () {
								$('#text-area').text('Oh wait. I think I was right. That is indeed the ' + numberToPrint(req_row) + ' row.')
								$('#next-area').fadeIn(900)
								$('#dialogue-next').click(function() {
									$('#next-area').fadeOut(400, function () {
										insideRow(req_row)
									})
									
								});
							})
						})
					}
				});
			}
			function end_game() {
				$('#next-area').fadeOut(400, function () {
					$('#text-area').text('Wow! What a beautiful picture we have drawn! I think I can see ' + getImage(img_id).desc + ' in the picture!')
					$('#next-area').fadeIn(900)
					$('#dialogue-next').click(function() {
						$('#dialogue-next').unbind()
						$('#next-area').fadeOut(400, function () {
							$('#text-area').text('I think we have enough time left to draw some more! Follow me!')
							$('#next-area').fadeIn(900)
							$('#dialogue-next').click(function() {
								$('#dialogue-next').unbind()
								$('.curtain').fadeOut(2000, function() {
									$('#ball-area').fadeIn(900)
									$('#next-area').fadeOut(400)
									$('.curtain').fadeIn(1500)
									sandbox_mode()
								})
							})
						})
					})
				})
			}
			function insideRow(req_row){
				colours = getColours()
				var req_col = getRandomNumber(0, 8)
				while(squareOccupiedOrWhite(req_row, req_col)) {
					req_col = getRandomNumber(0, 8)
				}
				var req_colour = target_img[req_row][req_col]
				$('.highlight').fadeOut(400)
				$('#text-area').text('Place the ' + colours[req_colour] + ' ball in the ' + numberToPrint(req_col) + ' position of the ' + numberToPrint(req_row)  + ' row')
				$('#ball-area').fadeIn(900)
				trialColour(req_row, req_col, req_colour)
			}
			function trialRow(req_row, t_counter = 0) {
				$('#numberinput-area').fadeIn(900)
				$('.numberinput-btn').click(function() {
					if (t_counter==2) {
						$('#numberinput-area').fadeOut(400, function () {
							$('#text-area').text('Oh, now I see! It is actually the ' + numberToPrint(req_row) + ' row!')
							// surprised
							$('#next-area').fadeIn(900)
							$('#dialogue-next').click(function() {
								$('#next-area').fadeOut(400, function () {
									row_indicator.fadeOut(400)
									$('#dialogue-next').unbind()
									insideRow(req_row)
								});
							})
						})
					}
					else if (($('#number').val()-1)==req_row) {
						$('#text-area').text('You are right! Silly me! It is indeed the ' + numberToPrint(req_row) + ' row!')
						// happy
						$('#numberinput-area').fadeOut(400, function () {
							$('#next-area').fadeIn(900)
							$('#dialogue-next').click(function() {
								$('#dialogue-next').unbind()
								$('#next-area').fadeOut(400, function () {
									insideRow(req_row)
								})
							});
						})
					} else if ( ($('#number').val()-1) != req_row || t_counter < 2) {
						$('#numberinput-area').fadeOut(400, function () {
						t_counter = t_counter + 1
						$('#text-area').text('Oh, that is not quite right! Let us try again.')
						// sad
							$('#next-area').fadeIn(900)
							$('#dialogue-next').click(function() {
								$('#dialogue-next').unbind()
								$('#next-area').fadeOut(400, function () {
									$('#text-area').text('Which row do you think that is?')
									$('#numberinput-area').fadeIn(900)
									if (t_counter==1) {
										row_indicator.fadeIn(900)
									}
								});
							});
						})
					}
				})
			}
			function trialCol(req_row, req_col, req_colour, picked){
				colours = getColours()
				$('.square').click(function() {
					var curr_square = this
					if(picked) {
						popColour($('#'+curr_square.id))
						$('#'+curr_square.id).addClass($('#ball').attr('class'));
						$('#ball').fadeOut(400, function() {
							$('#ball').removeClass();
							picked = false
							locked = true
							if(req_row != parseInt(curr_square.id.split('_')[1]/8)) {
								$('#text-area').text('This can\'t be the ' + numberToPrint(req_row) + ' row!')
								row_indicator.fadeIn(2500, function() {
									row_indicator.fadeOut(2500)
								})
								$('#next-area').fadeIn(900)
								$('#dialogue-next').click(function() {
									$('#dialogue-next').unbind()
									$('#next-area').fadeOut(400, function() {
										popColour($('#'+curr_square.id))
										$('#text-area').text('Place the ' + colours[req_colour] + ' ball in the ' + numberToPrint(req_col) + ' square of the ' + numberToPrint(req_row) + ' row.')
										locked = false
									})
								})
							}
							else if(req_col == curr_square.id.split('_')[1]%8) {
								$('#ball-area').fadeOut(400, function() {
									$('#text-area').text('Yay! We did it!')
									board_state[req_row][req_col] =  target_img[req_row][req_col]
									$('#next-area').fadeIn(900)
									$('#dialogue-next').click(function() {
										getHandlers().map(x => x.unbind())
										$('#next-area').fadeOut(400, function () {
											if (!imageFilled()) {
												$('#text-area').text('Let\'s keep going!')
												$('#next-area').fadeIn(900)
												$('#dialogue-next').click(function() {
													$('#dialogue-next').unbind();
													locked = false
													mid_game()
													
												});
											}
											else {
												end_game()
											}
										})
									});
								})
							}
							else {
								$('#text-area').text('That is not the right square! I believe that is the '
									+ numberToPrint(curr_square.id.split('_')[1]%8) + ' square. Let\'s try again!')
								$('#next-area').fadeIn(900)
								$('#dialogue-next').click(function() {
									$('#dialogue-next').unbind()
									$('#next-area').fadeOut(400, function() {
										let target_square = $('#square_' + (req_row*size+req_col))
										target_square.addClass('blink')
										target_square.fadeTo(600, 1, function() {
											target_square.fadeTo(600, 0.2, function() {
												target_square.removeClass('blink')
												target_square.removeAttr('style');
											})
										})
										popColour($('#'+curr_square.id))
										$('#text-area').text('Place the ' + colours[req_colour] + ' ball in the ' + numberToPrint(req_col) + ' square of the ' + numberToPrint(req_row) + ' row.')
										locked = false
									})
								});
							}
						})
					}
				})
			}
			function trialColour(req_row, req_col, req_colour){
				colours = getColours()
				$('.option').click(function() {
					if(!locked){
						var chosen_colour = getKeyByValue(colours, this.className.split(/\s+/)[1].split('-')[0])
						$('#ball').removeClass();
						$('#ball').fadeIn(900)
						$('#ball').addClass(this.className.split(/\s+/)[1])
						picked = true
						if(req_colour != chosen_colour) {
							$('#text-area').text('That is not the requested ball. Pick the ' + colours[req_colour] + ' ball.')
							$('#ball').fadeOut(400, function() {
								picked = false
								locked = false
							})
						}
						else {
							$('#text-area').text('You picked the ' + colours[req_colour] + ' ball! Now place it in the ' + numberToPrint(req_col) + ' square of the ' + numberToPrint(req_row) + ' row.')
							locked = true
							trialCol(req_row, req_col, req_colour, picked)
						}
					}
				})
			}
			function sandbox_mode() {
				getHandlers().map(x => {x.unbind()})
				$('.square').each(function(){
					popColour($(this))
				})
				$('#text-area').text('Welcome to the sandbox mode! We can play as much you would like here!')
				$('.option').click(function() {
					ball.removeClass();
					ball.css('display', 'block');
					ball.addClass(this.className.split(/\s+/)[1]);
					picked = true;
				})
				$('.square').click(function() {
					if(picked) {
						popColour($(this))
						$('#'+this.id).addClass(ball.attr('class'));
						ball.css('display', 'none');
						ball.removeClass();
					}
					else {
						popColour($(this))
					}
				});
			}
		</script>
	</footer>
</html>